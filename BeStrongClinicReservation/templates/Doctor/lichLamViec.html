{% block content %}

<link rel="shortcut icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename= 'images/clinic.png') }}">
<link rel="stylesheet" href="static/styleExe/WorkSchedule/workSchedule.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<meta name="description" content="Quản lý lịch làm việc Bác Sĩ">
<title>Đăng Ký Lịch Làm Việc</title>

<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-calendar-alt"></i> Lịch Làm Việc Của Tôi</h1>
            <label class="greeting">
                Xin chào BS. {{ current_doctor.name if current_doctor.name else current_doctor.username }}
            </label>
        </div>

        <div class="main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="flash-messages">
                        {% for category, message in messages %}
                            <div class="flash-message flash-{{ 'success' if category == 'success' else 'error' }}">
                                <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-circle' }}"></i>
                                {{ message }}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}

            <!-- Thông tin tuần làm việc -->
            <div class="week-info">
                <div>
                    <h3><i class="fas fa-calendar-week"></i> Tuần Làm Việc Tiếp Theo</h3>
                </div>
                <div class="week-dates">
                    {{ week_range }}
                </div>
            </div>

            <!-- Thông báo quan trọng -->
            <div class="section">
                <div class="alert alert-info" style="background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 12px 16px; border-radius: 6px; margin-bottom: 20px; display: flex; align-items: center;">
                    <i class="fas fa-info-circle" style="margin-right: 10px; font-size: 16px;"></i>
                    <span><strong>Lưu ý:</strong> Vui lòng đăng ký lịch làm việc trước thứ 7 hàng tuần. Lịch sẽ được admin duyệt trước khi có hiệu lực. Mỗi tuần bạn cần đăng ký lại lịch làm việc.</span>
                </div>
            </div>

            <!-- Phần lịch làm việc hiện tại -->
            <div class="section">
                <h2 class="section-title">
                    <i class="fas fa-clock"></i>
                    Lịch Làm Việc Tuần Tiếp Theo
                </h2>

                <div class="current-schedule">
                    {% if working_days_summary %}
                        <div class="schedule-summary">
                            {% for day_info in working_days_summary %}
                                <div class="day-summary">
                                    <h4>{{ day_info.day }}</h4>
                                    <div class="shift-details">
                                        {% for shift_info in day_info.shifts %}
                                            <div class="schedule-item-enhanced {{ shift_info.status_class }}">
                                                <div class="shift-info">
                                                    <div class="shift-icon {{ 'morning' if shift_info.shift == 'Sang' else 'afternoon' }}">
                                                        <i class="fas fa-{{ 'sun' if shift_info.shift == 'Sang' else 'moon' }}"></i>
                                                    </div>
                                                    <div>
                                                        <div class="shift-label">
                                                            {{ 'Buổi sáng' if shift_info.shift == 'Sang' else 'Buổi chiều' }}
                                                        </div>
                                                        {% if shift_info.reason %}
                                                            <div class="rejection-reason">
                                                                <i class="fas fa-exclamation-triangle"></i>
                                                                Lý do từ chối: {{ shift_info.reason }}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="status-badge status-{{ shift_info.status_class }}">
                                                    {{ shift_info.status }}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-calendar-times"></i>
                            <p>Bạn chưa đăng ký lịch làm việc nào cho tuần tiếp theo</p>
                            <small>Hãy đăng ký lịch làm việc bằng form bên dưới</small>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Phần chọn lịch làm việc -->
            <div class="section">
                <h2 class="section-title">
                    <i class="fas fa-edit"></i>
                    Đăng Ký Lịch Làm Việc Tuần Tiếp Theo
                </h2>

                <form method="POST" id="scheduleForm">
                    <div class="schedule-grid">
                        {% set days_grouped = {} %}
                        {% for slot in available_time_slots %}
                            {% if slot.thu_name not in days_grouped %}
                                {% set _ = days_grouped.update({slot.thu_name: []}) %}
                            {% endif %}
                            {% set _ = days_grouped[slot.thu_name].append(slot) %}
                        {% endfor %}

                        {% for day_name, slots in days_grouped.items() %}
                            <div class="day-card">
                                <h3 class="day-title">{{ day_name }}</h3>
                                <div class="shift-options">
                                    {% for slot in slots %}
                                        <div class="shift-checkbox
                                                    {{ 'selected' if slot.is_selected else '' }}
                                                    {{ 'occupied' if slot.is_occupied_by_other else '' }}">
                                            {% if slot.is_selected %}
                                                <div class="schedule-item">
                                                    <div style="display: flex; align-items: center; gap: 10px;">
                                                        <i class="fas fa-check-circle"></i>
                                                        <span class="shift-label">
                                                            {{ 'Buổi sáng' if slot.buoi == 'Sang' else 'Buổi chiều' }}
                                                        </span>
                                                        {% if slot.status %}
                                                            <span class="status-badge status-{{ slot.status_class }}">
                                                                {{ slot.status }}
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                    {% if slot.status_class != 'approved' %}
                                                        <button type="submit" name="action" value="remove" class="remove-btn"
                                                                onclick="document.getElementById('schedule_id').value='{{ slot.schedule_id }}'"
                                                                title="Hủy đăng ký ca này">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            {% elif slot.is_occupied_by_other %}
                                                <div class="occupied-slot">
                                                    <i class="fas fa-user-lock"></i>
                                                    <span class="shift-label">
                                                        {{ 'Buổi sáng' if slot.buoi == 'Sang' else 'Buổi chiều' }}
                                                    </span>
                                                    <small class="occupied-text">
                                                        {% if slot.occupied_doctor %}
                                                            (Đã có BS. {{ slot.occupied_doctor }})
                                                        {% else %}
                                                            (Đã có bác sĩ khác)
                                                        {% endif %}
                                                    </small>
                                                </div>
                                            {% else %}
                                                <label style="display: flex; align-items: center; cursor: pointer; width: 100%;">
                                                    <input type="checkbox" name="selected_slots"
                                                           value="{{ slot.thu }}_{{ slot.buoi }}"
                                                           onchange="toggleSlotSelection(this, {{ slot.thu }}, '{{ slot.buoi }}')">
                                                    <span class="shift-label">
                                                        {{ 'Buổi sáng' if slot.buoi == 'Sang' else 'Buổi chiều' }}
                                                    </span>
                                                </label>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <input type="hidden" name="thu" id="selected_thu">
                    <input type="hidden" name="buoi" id="selected_buoi">
                    <input type="hidden" name="schedule_id" id="schedule_id">

                    <div class="action-buttons">
                        <button type="submit" name="action" value="add" class="btn btn-primary" id="addButton" disabled>
                            <i class="fas fa-plus"></i>
                            Đăng ký lịch đã chọn
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let selectedSlots = [];

        function toggleSlotSelection(checkbox, thu, buoi) {
            const slotKey = `${thu}_${buoi}`;

            if (checkbox.checked) {
                if (!selectedSlots.find(slot => slot.key === slotKey)) {
                    selectedSlots.push({
                        key: slotKey,
                        thu: thu,
                        buoi: buoi,
                        element: checkbox.parentElement.parentElement
                    });
                }
                checkbox.parentElement.parentElement.classList.add('selected');
            } else {
                selectedSlots = selectedSlots.filter(slot => slot.key !== slotKey);
                checkbox.parentElement.parentElement.classList.remove('selected');
            }

            updateAddButton();
        }

        function updateAddButton() {
            const addButton = document.getElementById('addButton');
            if (selectedSlots.length > 0) {
                addButton.disabled = false;
                addButton.innerHTML = `<i class="fas fa-plus"></i> Đăng ký ${selectedSlots.length} ca đã chọn`;
            } else {
                addButton.disabled = true;
                addButton.innerHTML = '<i class="fas fa-plus"></i> Đăng ký lịch đã chọn';
            }
        }

        document.getElementById('scheduleForm').addEventListener('submit', function(e) {
            const action = e.submitter.value;

            if (action === 'add') {
                e.preventDefault();

                if (selectedSlots.length === 0) {
                    alert('Vui lòng chọn ít nhất một ca làm việc!');
                    return;
                }

                selectedSlots.forEach(slot => {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.style.display = 'none';

                    const actionInput = document.createElement('input');
                    actionInput.name = 'action';
                    actionInput.value = 'add';
                    form.appendChild(actionInput);

                    const thuInput = document.createElement('input');
                    thuInput.name = 'thu';
                    thuInput.value = slot.thu;
                    form.appendChild(thuInput);

                    const buoiInput = document.createElement('input');
                    buoiInput.name = 'buoi';
                    buoiInput.value = slot.buoi;
                    form.appendChild(buoiInput);

                    document.body.appendChild(form);
                    form.submit();
                });
            }
        });

        // Flash message auto hide
        document.addEventListener('DOMContentLoaded', function() {
            const flashMessages = document.querySelectorAll('.flash-message');
            flashMessages.forEach(function(message) {
                setTimeout(function() {
                    message.style.transition = 'opacity 0.5s ease';
                    message.style.opacity = '0';
                    setTimeout(function() {
                        message.remove();
                    }, 500);
                }, 3000);
            });
        });
    </script>
</body>
{% endblock %}